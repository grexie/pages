{"version":3,"file":"index.cjs","names":["_sourceMaps","require","_resolvable","_crypto","_css","_astTraverse","_interopRequireDefault","_module","obj","__esModule","default","StyleLoader","content","inputSourceMap","process","env","PAGES_DEBUG_LOADERS","console","debug","resourcePath","resolver","createResolver","callback","async","createRequire","module","id","exports","Function","toString","styles","css","variables","parseVariables","locals","hash","createHash","update","digest","chunk","JSON","stringify","map","sourceMap","offsetLines","split","length","err","reject","resolve","ast","parseCSS","source","traverse","pre","node","parent","type","children","stylesheet","rules","property","startsWith","selectors","includes","value"],"sources":["../src/index.ts"],"sourcesContent":["import { LoaderContext } from 'webpack';\nimport { offsetLines } from '@grexie/source-maps';\nimport { createResolver } from '@grexie/resolvable';\nimport { createHash } from 'crypto';\nimport { parse as parseCSS } from 'css';\nimport { default as traverse } from 'ast-traverse';\nimport { createRequire } from 'module';\n\nexport default async function StyleLoader(\n  this: LoaderContext<void>,\n  content: Buffer,\n  inputSourceMap: any\n) {\n  if (process.env.PAGES_DEBUG_LOADERS === 'true') {\n    console.debug('style-loader', this.resourcePath);\n  }\n  const resolver = createResolver();\n  // context.modules.addBuild(this.resourcePath, resolver);\n  const callback = this.async();\n\n  // const factory = context.modules.createModuleFactory(this._compilation!);\n\n  try {\n    const require = createRequire(this.resourcePath);\n    const module: any = {\n      id: this.resourcePath,\n      exports: {},\n      require,\n    };\n\n    new Function('module', 'exports', 'require', content.toString())(\n      module,\n      module.exports,\n      require\n    );\n\n    const styles = module.exports;\n    const css = styles.toString();\n    const variables = parseVariables(css, this.resourcePath);\n\n    const { locals } = styles;\n    const hash = createHash('md5').update(this.resourcePath).digest('hex');\n    const chunk = `\n    import { wrapStyles } from '@grexie/pages-runtime-styles';\n    export default wrapStyles(${JSON.stringify(hash)}, ${JSON.stringify(\n      css\n    )}, ${JSON.stringify(locals, null, 2)}, ${JSON.stringify(variables)}); \n  `;\n\n    let map;\n\n    if (this.sourceMap) {\n      map =\n        inputSourceMap &&\n        (await offsetLines(inputSourceMap, chunk.split(/\\r\\n|\\n/g).length));\n    }\n\n    callback(null, chunk, inputSourceMap);\n  } catch (err) {\n    callback(err as any);\n    resolver.reject(err);\n  } finally {\n    if (process.env.PAGES_DEBUG_LOADERS === 'true') {\n      console.debug('style-loader:complete', this.resourcePath);\n    }\n\n    resolver.resolve();\n  }\n}\n\nexport const parseVariables = (css: string, resourcePath: string) => {\n  const ast = parseCSS(css, {\n    source: resourcePath,\n  });\n\n  const variables: Record<string, string> = {};\n\n  traverse(ast, {\n    pre: (node: any, parent: any) => {\n      if (node.type === 'stylesheet') {\n        node.children = node.stylesheet.rules;\n      }\n      if (\n        node.type === 'declaration' &&\n        node.property.startsWith('--') &&\n        parent.selectors.includes(':root')\n      ) {\n        variables[node.property] = node.value;\n      }\n    },\n  });\n\n  return variables;\n};\n"],"mappings":"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"}