{"version":3,"file":"index.mjs","names":["offsetLines","createResolver","createHash","parse","parseCSS","default","traverse","createRequire","StyleLoader","content","inputSourceMap","process","env","PAGES_DEBUG_LOADERS","console","debug","resourcePath","resolver","callback","async","require","module","id","exports","Function","toString","styles","css","variables","parseVariables","locals","hash","update","digest","chunk","JSON","stringify","map","sourceMap","split","length","err","reject","resolve","ast","source","pre","node","parent","type","children","stylesheet","rules","property","startsWith","selectors","includes","value"],"sources":["../src/index.ts"],"sourcesContent":["import { LoaderContext } from 'webpack';\nimport { offsetLines } from '@grexie/source-maps';\nimport { createResolver } from '@grexie/resolvable';\nimport { createHash } from 'crypto';\nimport { parse as parseCSS } from 'css';\nimport { default as traverse } from 'ast-traverse';\nimport { createRequire } from 'module';\n\nexport default async function StyleLoader(\n  this: LoaderContext<void>,\n  content: Buffer,\n  inputSourceMap: any\n) {\n  if (process.env.PAGES_DEBUG_LOADERS === 'true') {\n    console.debug('style-loader', this.resourcePath);\n  }\n  const resolver = createResolver();\n  // context.modules.addBuild(this.resourcePath, resolver);\n  const callback = this.async();\n\n  // const factory = context.modules.createModuleFactory(this._compilation!);\n\n  try {\n    const require = createRequire(this.resourcePath);\n    const module: any = {\n      id: this.resourcePath,\n      exports: {},\n      require,\n    };\n\n    new Function('module', 'exports', 'require', content.toString())(\n      module,\n      module.exports,\n      require\n    );\n\n    const styles = module.exports;\n    const css = styles.toString();\n    const variables = parseVariables(css, this.resourcePath);\n\n    const { locals } = styles;\n    const hash = createHash('md5').update(this.resourcePath).digest('hex');\n    const chunk = `\n    import { wrapStyles } from '@grexie/pages-runtime-styles';\n    export default wrapStyles(${JSON.stringify(hash)}, ${JSON.stringify(\n      css\n    )}, ${JSON.stringify(locals, null, 2)}, ${JSON.stringify(variables)}); \n  `;\n\n    let map;\n\n    if (this.sourceMap) {\n      map =\n        inputSourceMap &&\n        (await offsetLines(inputSourceMap, chunk.split(/\\r\\n|\\n/g).length));\n    }\n\n    callback(null, chunk, inputSourceMap);\n  } catch (err) {\n    callback(err as any);\n    resolver.reject(err);\n  } finally {\n    if (process.env.PAGES_DEBUG_LOADERS === 'true') {\n      console.debug('style-loader:complete', this.resourcePath);\n    }\n\n    resolver.resolve();\n  }\n}\n\nexport const parseVariables = (css: string, resourcePath: string) => {\n  const ast = parseCSS(css, {\n    source: resourcePath,\n  });\n\n  const variables: Record<string, string> = {};\n\n  traverse(ast, {\n    pre: (node: any, parent: any) => {\n      if (node.type === 'stylesheet') {\n        node.children = node.stylesheet.rules;\n      }\n      if (\n        node.type === 'declaration' &&\n        node.property.startsWith('--') &&\n        parent.selectors.includes(':root')\n      ) {\n        variables[node.property] = node.value;\n      }\n    },\n  });\n\n  return variables;\n};\n"],"mappings":"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"}