{"version":3,"file":"index.mjs","names":["transformAsync","MetadataLoader","content","inputSourceMap","process","env","PAGES_DEBUG_LOADERS","console","debug","resourcePath","callback","async","compiled","toString","plugins","configModulePlugin","filename","sourceFileName","sourceMaps","sourceMap","code","map","err","error","types","t","visitor","ExportDefaultDeclaration","enter","path","insertBefore","importDeclaration","importSpecifier","identifier","stringLiteral","variableDeclaration","variableDeclarator","node","declaration","remove","Program","exit","body","push","exportDefaultDeclaration","callExpression"],"sources":["../src/index.ts"],"sourcesContent":["import { LoaderContext } from 'webpack';\nimport babel, { transformAsync, PluginObj, PluginPass } from '@babel/core';\n\nexport default async function MetadataLoader(\n  this: LoaderContext<void>,\n  content: Buffer,\n  inputSourceMap: any\n) {\n  if (process.env.PAGES_DEBUG_LOADERS === 'true') {\n    console.debug('metadata-loader', this.resourcePath);\n  }\n  const callback = this.async();\n\n  try {\n    const compiled = await transformAsync(content.toString(), {\n      plugins: [configModulePlugin],\n      filename: this.resourcePath,\n      sourceFileName: this.resourcePath,\n      inputSourceMap: inputSourceMap,\n      sourceMaps: !!this.sourceMap,\n    });\n\n    callback(null, compiled?.code ?? '', compiled!.map!);\n  } catch (err) {\n    console.error(err);\n    callback(err as any);\n  } finally {\n    if (process.env.PAGES_DEBUG_LOADERS === 'true') {\n      console.debug('metadata-loader:complete', this.resourcePath);\n    }\n  }\n}\n\nconst configModulePlugin: (b: typeof babel) => PluginObj<PluginPass> = ({\n  types: t,\n}) => ({\n  visitor: {\n    ExportDefaultDeclaration: {\n      enter: path => {\n        path.insertBefore(\n          t.importDeclaration(\n            [\n              t.importSpecifier(\n                t.identifier('__pages_wrap_metadata'),\n                t.identifier('wrapMetadata')\n              ),\n            ],\n            t.stringLiteral('@grexie/pages-runtime-metadata')\n          )\n        );\n        path.insertBefore(\n          t.variableDeclaration('const', [\n            t.variableDeclarator(\n              t.identifier('__pages_metadata'),\n              path.node.declaration as any\n            ),\n          ])\n        );\n        path.remove();\n      },\n    },\n    Program: {\n      exit(path) {\n        path.node.body.push(\n          t.exportDefaultDeclaration(\n            t.callExpression(t.identifier('__pages_wrap_metadata'), [\n              t.identifier('__pages_metadata'),\n            ])\n          )\n        );\n      },\n    },\n  },\n});\n"],"mappings":"AACA,SAAgBA,cAAc,QAA+B,aAAa;AAE1E,eAAe,eAAeC,cAAcA,CAE1CC,OAAe,EACfC,cAAmB,EACnB;EACA,IAAIC,OAAO,CAACC,GAAG,CAACC,mBAAmB,KAAK,MAAM,EAAE;IAC9CC,OAAO,CAACC,KAAK,CAAC,iBAAiB,EAAE,IAAI,CAACC,YAAY,CAAC;EACrD;EACA,MAAMC,QAAQ,GAAG,IAAI,CAACC,KAAK,CAAC,CAAC;EAE7B,IAAI;IACF,MAAMC,QAAQ,GAAG,MAAMZ,cAAc,CAACE,OAAO,CAACW,QAAQ,CAAC,CAAC,EAAE;MACxDC,OAAO,EAAE,CAACC,kBAAkB,CAAC;MAC7BC,QAAQ,EAAE,IAAI,CAACP,YAAY;MAC3BQ,cAAc,EAAE,IAAI,CAACR,YAAY;MACjCN,cAAc,EAAEA,cAAc;MAC9Be,UAAU,EAAE,CAAC,CAAC,IAAI,CAACC;IACrB,CAAC,CAAC;IAEFT,QAAQ,CAAC,IAAI,EAAEE,QAAQ,EAAEQ,IAAI,IAAI,EAAE,EAAER,QAAQ,CAAES,GAAI,CAAC;EACtD,CAAC,CAAC,OAAOC,GAAG,EAAE;IACZf,OAAO,CAACgB,KAAK,CAACD,GAAG,CAAC;IAClBZ,QAAQ,CAACY,GAAU,CAAC;EACtB,CAAC,SAAS;IACR,IAAIlB,OAAO,CAACC,GAAG,CAACC,mBAAmB,KAAK,MAAM,EAAE;MAC9CC,OAAO,CAACC,KAAK,CAAC,0BAA0B,EAAE,IAAI,CAACC,YAAY,CAAC;IAC9D;EACF;AACF;AAEA,MAAMM,kBAA8D,GAAGA,CAAC;EACtES,KAAK,EAAEC;AACT,CAAC,MAAM;EACLC,OAAO,EAAE;IACPC,wBAAwB,EAAE;MACxBC,KAAK,EAAEC,IAAI,IAAI;QACbA,IAAI,CAACC,YAAY,CACfL,CAAC,CAACM,iBAAiB,CACjB,CACEN,CAAC,CAACO,eAAe,CACfP,CAAC,CAACQ,UAAU,CAAC,uBAAuB,CAAC,EACrCR,CAAC,CAACQ,UAAU,CAAC,cAAc,CAC7B,CAAC,CACF,EACDR,CAAC,CAACS,aAAa,CAAC,gCAAgC,CAClD,CACF,CAAC;QACDL,IAAI,CAACC,YAAY,CACfL,CAAC,CAACU,mBAAmB,CAAC,OAAO,EAAE,CAC7BV,CAAC,CAACW,kBAAkB,CAClBX,CAAC,CAACQ,UAAU,CAAC,kBAAkB,CAAC,EAChCJ,IAAI,CAACQ,IAAI,CAACC,WACZ,CAAC,CACF,CACH,CAAC;QACDT,IAAI,CAACU,MAAM,CAAC,CAAC;MACf;IACF,CAAC;IACDC,OAAO,EAAE;MACPC,IAAIA,CAACZ,IAAI,EAAE;QACTA,IAAI,CAACQ,IAAI,CAACK,IAAI,CAACC,IAAI,CACjBlB,CAAC,CAACmB,wBAAwB,CACxBnB,CAAC,CAACoB,cAAc,CAACpB,CAAC,CAACQ,UAAU,CAAC,uBAAuB,CAAC,EAAE,CACtDR,CAAC,CAACQ,UAAU,CAAC,kBAAkB,CAAC,CACjC,CACH,CACF,CAAC;MACH;IACF;EACF;AACF,CAAC,CAAC"}