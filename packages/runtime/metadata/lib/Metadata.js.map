{"version":3,"file":"Metadata.js","names":["ContextTable","WeakMap","stack","Metadata","constructor","object","parent","root","path","self","Proxy","get","target","p","subs","value","length","Array","isArray","map","trim","startsWith","endsWith","program","substring","keys","from","Reflect","ownKeys","filter","x","values","k","Function","o","cmp","push","parentValue","pop","set","_","newValue","n","deleteProperty","out","Set","add","sort","getOwnPropertyDescriptor","enumerable","configurable","writable","getContext","metadata","setContext","context"],"sources":["../src/Metadata.ts"],"sourcesContent":["const ContextTable = new WeakMap();\n\nexport interface MetadataContext {\n  filename: string;\n}\n\nexport interface Metadata {\n  [k: string | symbol | number]: any;\n}\n\nconst stack: (string | symbol)[] = [];\n\nexport class Metadata {\n  constructor(\n    object: any,\n    parent?: Metadata,\n    root?: Metadata,\n    path: (string | symbol | number)[] = []\n  ) {\n    const self: Metadata = new Proxy(object, {\n      get(target, p) {\n        const subs = (value: any): any | any[] => {\n          if (stack.length) {\n            return value;\n          }\n\n          if (Array.isArray(value)) {\n            return value.map(subs);\n          } else if (\n            typeof value === 'string' &&\n            value.trim().startsWith('${') &&\n            value.trim().endsWith('}')\n          ) {\n            let program = value.trim();\n            program = program.substring(2, program.length - 1);\n            const keys = Array.from(Reflect.ownKeys(root ?? self)).filter(\n              x => typeof x === 'string' && (path.length > 0 || x !== p)\n            ) as string[];\n\n            const values = keys.map(k => Reflect.get(root ?? self, k));\n\n            return (\n              new Function(...keys, `return (${program});`)(...values) ?? null\n            );\n          }\n\n          return value;\n        };\n\n        let o = object;\n        for (let cmp of path) {\n          o = o?.[cmp];\n        }\n        let value = o?.[p];\n        stack.push(p);\n        const parentValue = parent?.[p];\n        stack.pop();\n\n        if (typeof value === 'undefined') {\n          if (\n            !Array.isArray(parentValue) &&\n            typeof parentValue === 'object' &&\n            parentValue !== null\n          ) {\n            return new Metadata(object, parentValue, root ?? self, [\n              ...path,\n              p,\n            ]);\n          } else {\n            return subs(parentValue);\n          }\n        } else if (\n          !Array.isArray(value) &&\n          typeof value === 'object' &&\n          value !== null\n        ) {\n          return new Metadata(object, parentValue, root ?? self, [...path, p]);\n        }\n\n        return subs(value);\n      },\n      set(_, p, newValue) {\n        let o = object;\n        for (let cmp of path) {\n          let n = Reflect.get(o, cmp);\n          if (typeof n === 'undefined') {\n            n = {};\n            o[cmp] = n;\n          }\n          o = n;\n        }\n\n        return Reflect.set(o, p, newValue);\n      },\n      deleteProperty(_, p) {\n        let o = object;\n        for (let cmp of path) {\n          let n = o[cmp];\n          if (typeof n === 'undefined') {\n            return false;\n          }\n          o = n;\n        }\n        return Reflect.deleteProperty(o, p);\n      },\n      ownKeys(_) {\n        let out = new Set<string | symbol>();\n        let o = object;\n        for (let cmp of path) {\n          o = o?.[cmp];\n        }\n        if (typeof o === 'object' && o !== null) {\n          for (const k of Reflect.ownKeys(o)) {\n            out.add(k);\n          }\n        }\n        if (parent) {\n          for (const k of Reflect.ownKeys(parent)) {\n            out.add(k);\n          }\n        }\n        return [...out].sort();\n      },\n      getOwnPropertyDescriptor(target, p) {\n        let o = object;\n        for (let cmp of path) {\n          o = o?.[cmp];\n        }\n        o = o?.[p];\n        if (typeof o !== 'undefined') {\n          return {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: this.get!(target, p, target),\n          };\n        } else if (parent) {\n          return Reflect.getOwnPropertyDescriptor(parent, p);\n        }\n      },\n    });\n    return self;\n  }\n\n  static getContext(metadata: Metadata) {\n    return ContextTable.get(metadata);\n  }\n\n  static setContext(metadata: Metadata, context: MetadataContext) {\n    ContextTable.set(metadata, context);\n  }\n}\n"],"mappings":"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"}